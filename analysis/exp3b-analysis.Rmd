---
title: "Experiment 3 Timepoint 2 Analysis"
author: "Josh White"
date: "03/01/2022"
output: 
  html_document:
    df_print: paged
    theme: journal
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
        collapsed: false
        smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, cache = TRUE, message = FALSE)

library(tidyverse)
library(here)

# Visualisation
library(ggsci)
library(ggrepel)
library(moderndive) # for geom_parallel_slopes_function because there is no way to do this in 

# Modeling
library(lme4)
library(ordinal) # for clmm function
library(brms) # for Bayesian analyses

# Tables
library(flextable)
library(ftExtra)

theme_set(theme_classic())
```

# Introductory Steps

## Load Packages and set seed for reproducibility

```{r load-packages, eval = FALSE}
library(tidyverse)
library(here)

# Visualisation
library(ggsci)
library(ggrepel)
library(moderndive) # for geom_parallel_slopes_function because there is no way to do this in 

# Modeling
library(lme4)
library(ordinal) # for clmm function
library(brms) # for Bayesian analyses

# Tables
library(flextable)
library(ftExtra)

theme_set(theme_classic())

set.seed(3838)
```

## Import Data

```{r import-data, warning = FALSE}
db <- read_csv(
  here::here("experiment3", "timepoint2", "data", "exp3b-data.csv"),
  na = c("", "NA", "na")
  )

db_wid <- read_csv(
  here::here("experiment3", "timepoint2", "data", "3b_s-to-w.csv"),
  na = c("", "NA", "na")
  )

db <- db %>% 
  left_join(db_wid)

#WRANGLE 3B

#make factors 
db <- db %>% 
  mutate(
    gender = factor(gender),
    income = factor(income, levels = c("<20k", "20to40k", "40to60K", "60to80k", "80to100k", ">100k")), 
    vignette = factor(vignette, levels = c("G1", "G2", "G5", "G9", "G11", 
                                           "L1", "L2", "L5", "L10", "L11")),
    education = as.numeric(education)
  )


# get ambiguity aversion and direction
db <- db %>% 
  mutate(
    AA = case_when(
      resp_order == "A" ~ -(response - 4),
      resp_order == "B" ~ response - 4,      
    ),
    direction = case_when(
      grepl("G", vignette) ~ "G",
      grepl("L", vignette) ~ "L"
    )
  )

#get whether passed attn_check or not
db <- db %>% 
  mutate(
    attn_pass = dummyVignetteAnswer > 4
  )

# get basic descriptives before exclusion
demo_d <- db %>% 
  distinct(subject, gender, age, education, income, attn_pass)

demo_d %>%  skimr::skim()

demo_d %>% 
  count(gender) %>% 
  arrange(desc(n)) %>% 
  flextable::flextable()

demo_d %>% 
  ggplot(aes(x = age)) + 
  geom_histogram(fill = "light blue", col = "black") +
  annotate(geom = "text", x = 60, y = 25,
            label = paste0("M (SD) = ", round(mean(demo_d$age), 2), " (", round(sd(demo_d$age), 2), ")")
  )


demo_d %>% 
  ggplot(aes(x = education)) + 
  geom_histogram(fill = "light blue", col = "black") +
  annotate(geom = "text", x = 20, y = 50,
            label = paste0("M (SD) = ", round(mean(demo_d$education, na.rm = TRUE), 2), 
                           " (", round(sd(demo_d$education, na.rm = TRUE), 2), ")")
  )


demo_d %>% 
  count(income) %>% 
  arrange(desc(n)) %>% 
  flextable::flextable()

```

## exclude participants

```{r exclude}
#check whether observations fail instruction checks
demo_d %>% 
  count(attn_pass) %>% 
  flextable::flextable()

d_pass <- db[db$attn_pass,]

```

## Plot Descriptives

```{r datawrangle, fig.height=7, fig.width = 5}
library(ggdist)

# using ggdists
d_pass %>% 
  ggplot(aes(x = AA, y = fct_rev(vignette), fill = vignette)) +
  stat_halfeye(point_interval = "mean_hdci",
               .width = c(.66, .95),
               slab_alpha = 0.5,
               normalize = "groups", 
               show.legend = FALSE) +
  ggsci::scale_fill_d3() +
  labs(y = "vignette")

# scatter and means
d_pass %>% 
  ggplot(aes(x = vignette, y = AA, fill = direction)) +
  geom_jitter(alpha = 0.25) +
  stat_summary(geom = "bar", fun = mean, alpha = 0.75) +
  stat_summary(geom = "errorbar", fun.data = mean_se, alpha = 0.75, width = 0.5) 


```

## Order effects (Trial number)

There is evidence of order effects as the model including trial order has superior fit. In both Bayesian and Frequentist models the model including an effect for `trialn` had a lower IC than the null model. Participants were less likely to choose a response option of higher ambiguity aversion as the trial number increased. For each trial the odds are multiplied by 0.96 (`exp(-0.04`), and the odds of choosing a higher ambiguity aversion option decrease by 30% compared to the the first trial (`exp(-0.04)^9`).


```{r  class.source = "fold-show"}

m0 <- clmm(ordered(AA) ~ 1 + (1|subject) + (1|vignette), d_pass)
m_order <- clmm(ordered(AA) ~ 1 + trialn + (1|subject) + (1|vignette), d_pass)

AIC(m0)
AIC(m_order)

summary(m0)
summary(m_order)

#bayes
m0_bayes <- brm(ordered(AA) ~ 1 + (1|subject) + (1|vignette), 
                family = cumulative(link = "logit"), 
                data = d_pass, 
                cores = 4,
                refresh = 0, open_progress = FALSE)

m_order_bayes <- brm(ordered(AA) ~ 1 + trialn + (1|subject) + (1|vignette), 
                     family = cumulative(link = "logit"),
                     data = d_pass, 
                     cores = 4,
                     refresh = 0, open_progress = FALSE)

#MODELS
m0_bayes %>%  summary()
m_order_bayes %>%  summary()

##LOO COMPARE
loo(m0_bayes)
loo(m_order_bayes)

```

### Plot order effects 

```{r}
d_pass %>% 
  ggplot(aes(x = trialn, y = AA)) +
  geom_jitter() +
  geom_smooth(method = "lm")
```

### Distribution of vignettes at each trial

Our randomisation constraint of only accepting trial orders in which the pair vignettes were at least three places apart, selected a distribution in which the non-pairs vignettes were more likely in the middle of the trialorder, while the pairs vignettes were more likely at the end. This could explain (a very small part of) some of the differences in Ambiguity Aversion between vignettes. However, such a difference is not likely to cause issues, as our analysis is within-participants.

```{r}
d_pass %>% 
  ggplot(aes(x = trialn, fill = vignette)) +
  geom_bar() +
  ggsci::scale_fill_d3()
```

However, even within each vignette, the order effect above is pretty consistent -- all vignettes had a similar decreasing pattern to differing degrees (except G11 with v slight rise, and L2 and L5 which were pretty much flat)

```{r}
d_pass %>% 
  ggplot(aes(x = trialn, y = AA)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  facet_wrap(~vignette)

```

However, the pattern is not obvious at the individual level (which is quite noisy)

```{r, fig.width = 7, fig.height= 10}

#pattern not obvious at the individual level
d_pass %>% 
  ggplot(aes(x = trialn, y = AA)) +
  geom_line() +
  facet_wrap(~subject, ncol = 11) +
  scale_x_continuous(breaks = c(2, 5, 8)) +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    #axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

## Relative order effects

Relative order has no effect on responses. AIC is lower for model without relative order parameter (LOOIC for Bayesian versions).

```{r, class.source = "fold-show"}
d_pairs <- d_pass %>% 
  filter(vignette %in% c("G1", "L1", "G2", "L2", "G5", "L5"))

d_pairs <- d_pairs %>% 
  mutate(
    pair = case_when(
      vignette %in% c("G1", "L1") ~ "ones",
      vignette %in% c("G2", "L2") ~ "twos",    
      vignette %in% c("G5", "L5") ~ "fives",    
    )
)

#code rel_order variable, which is TRUE when gain version of pair occurs first and FALSE when Loss version is
d_pairs <- d_pairs %>% 
  group_by(pair, subject) %>% 
  mutate(
    rel_order_gfirst = trialn[grepl("G", vignette)] < trialn[grepl("L", vignette)]
  ) %>% 
  ungroup()

## MODEL
#freq
m0_pairs <- clmm(ordered(AA) ~ 1 + (1|subject) + (1|vignette), d_pairs)
m_relorder <- clmm(ordered(AA) ~ 1 + rel_order_gfirst + (1|subject) + (1|vignette), d_pairs)

AIC(m0_pairs)
AIC(m_relorder)

summary(m0_pairs)
summary(m_relorder)


#bayes
m0_pairs_bayes <- brm(ordered(AA) ~ 1 + (1|subject) + (1|vignette), 
                data = d_pairs, family = cumulative(link = "logit"), 
                #refresh = 0, open_progress = FALSE,
                cores = 4)

m_relorder_bayes <- brm(ordered(AA) ~ 1 + rel_order_gfirst + (1|subject) + (1|vignette), 
               data = d_pairs, family = cumulative(link = "logit"), 
                #refresh = 0, open_progress = FALSE,
               cores = 4)

#MODELS
m0_pairs_bayes %>%  summary()
m_relorder_bayes %>%  summary()

##LOO COMPARE
loo(m0_pairs_bayes)
loo(m_relorder_bayes)
  
```

